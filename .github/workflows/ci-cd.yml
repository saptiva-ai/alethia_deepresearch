name: ğŸš€ CI/CD Pipeline - Aletheia Deep Research

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================
  # ğŸ§ª QUALITY ASSURANCE & TESTING
  # ==========================================
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    
    services:
      weaviate:
        image: semitechnologies/weaviate:1.22.4
        ports:
          - 8080:8080
        env:
          QUERY_DEFAULTS_LIMIT: 25
          AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
          PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
          DEFAULT_VECTORIZER_MODULE: 'none'
          ENABLE_MODULES: ''
          CLUSTER_HOSTNAME: 'node1'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-html pytest-json-report

    - name: ğŸ” Code Quality - Linting
      run: |
        pip install ruff black mypy
        echo "ğŸ” Running Ruff linter..."
        ruff check . --output-format=github
        echo "ğŸ¨ Checking code formatting..."
        black --check --diff .
        echo "ğŸ”¬ Running MyPy type checks..."
        mypy . --ignore-missing-imports || true

    - name: ğŸ›¡ï¸ Security Scan
      run: |
        pip install bandit safety
        echo "ğŸ›¡ï¸ Running Bandit security scan..."
        bandit -r . -f json -o bandit-report.json || true
        echo "ğŸ”’ Checking for known vulnerabilities..."
        safety check --json --output safety-report.json || true

    - name: ğŸ§ª Run Test Suite
      env:
        SAPTIVA_API_KEY: ${{ secrets.SAPTIVA_API_KEY_TEST }}
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY_TEST }}
        WEAVIATE_HOST: http://localhost:8080
        ENVIRONMENT: test
      run: |
        echo "ğŸ§ª Running comprehensive test suite..."
        python -m pytest \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --html=test-results.html \
          --json-report --json-report-file=test-results.json \
          --tb=short \
          -v

    - name: ğŸ“Š Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: aletheia-coverage

    - name: ğŸ“ˆ Coverage Comment
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}

    - name: ğŸ“‹ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          test-results.html
          test-results.json
          coverage.xml
          htmlcov/
          bandit-report.json
          safety-report.json

  # ==========================================
  # ğŸ—ï¸ BUILD & PACKAGE
  # ==========================================
  build:
    name: ğŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: test
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ³ Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          PYTHON_VERSION=${{ env.PYTHON_VERSION }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ github.ref_name }}

    - name: ğŸ”’ Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ steps.meta.outputs.tags }}
        format: spdx-json
        output-file: sbom.spdx.json

    - name: ğŸ›¡ï¸ Scan Image for Vulnerabilities
      uses: anchore/scan-action@v3
      if: github.event_name != 'pull_request'
      with:
        image: ${{ steps.meta.outputs.tags }}
        fail-build: false
        severity-cutoff: high

  # ==========================================
  # ğŸš€ DEPLOYMENT
  # ==========================================
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Staging
      env:
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
        SAPTIVA_API_KEY: ${{ secrets.SAPTIVA_API_KEY_STAGING }}
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY_STAGING }}
      run: |
        echo "ğŸš€ Deploying Aletheia to staging environment..."
        echo "ğŸ“¦ Image: $IMAGE_TAG"
        # Add your staging deployment commands here
        # kubectl set image deployment/aletheia aletheia=$IMAGE_TAG
        # helm upgrade aletheia ./helm/aletheia --set image.tag=$IMAGE_TAG

    - name: ğŸ§ª Run Smoke Tests
      run: |
        echo "ğŸ§ª Running staging smoke tests..."
        # Add health checks and basic functionality tests
        # curl -f https://staging.aletheia.example.com/health

  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ­ Deploy to Production
      env:
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
        SAPTIVA_API_KEY: ${{ secrets.SAPTIVA_API_KEY_PROD }}
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY_PROD }}
      run: |
        echo "ğŸ­ Deploying Aletheia to production environment..."
        echo "ğŸ“¦ Image: $IMAGE_TAG"
        # Add your production deployment commands here
        # kubectl set image deployment/aletheia aletheia=$IMAGE_TAG
        # helm upgrade aletheia ./helm/aletheia --set image.tag=$IMAGE_TAG

    - name: ğŸ§ª Run Production Health Checks
      run: |
        echo "ğŸ§ª Running production health checks..."
        # Add comprehensive health checks
        # curl -f https://aletheia.example.com/health

    - name: ğŸ“¢ Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        files: |
          sbom.spdx.json
        generate_release_notes: true
        make_latest: true

  # ==========================================
  # ğŸ“Š PERFORMANCE & MONITORING
  # ==========================================
  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: âš¡ Run Performance Tests
      run: |
        pip install locust pytest-benchmark
        echo "âš¡ Running performance benchmarks..."
        python scripts/benchmark_performance.py --environment=staging
        
    - name: ğŸ“Š Upload Performance Results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance-results/

  # ==========================================
  # ğŸ“ DOCUMENTATION
  # ==========================================
  docs:
    name: ğŸ“ Generate Documentation  
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Documentation Dependencies
      run: |
        pip install sphinx sphinx-rtd-theme myst-parser
        pip install -r requirements.txt

    - name: ğŸ“ Generate API Documentation
      run: |
        echo "ğŸ“ Generating API documentation..."
        # Add sphinx or other doc generation commands
        # sphinx-apidoc -o docs/source .
        # sphinx-build -b html docs/source docs/build

    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/build