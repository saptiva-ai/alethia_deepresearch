name: ğŸ” PR Review & Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

jobs:
  # ==========================================
  # ğŸ” CODE REVIEW AUTOMATION
  # ==========================================
  code-review:
    name: ğŸ” Automated Code Review
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Review Tools
      run: |
        pip install ruff black mypy bandit safety
        pip install -r requirements.txt

    - name: ğŸ” Code Quality Check
      run: |
        echo "ğŸ” Running comprehensive code quality checks..."
        
        # Linting with detailed output
        echo "ğŸ“‹ Linting with Ruff..."
        ruff check . --output-format=github --show-fixes
        
        # Code formatting check
        echo "ğŸ¨ Checking code formatting..."
        black --check --diff --color .
        
        # Type checking
        echo "ğŸ”¬ Type checking with MyPy..."
        mypy . --show-error-codes --ignore-missing-imports
        
        # Security analysis
        echo "ğŸ›¡ï¸ Security scan with Bandit..."
        bandit -r . -ll -f txt
        
        # Dependency vulnerability check
        echo "ğŸ”’ Checking dependencies for vulnerabilities..."
        safety check --short-report

    - name: ğŸ“Š Code Complexity Analysis
      run: |
        pip install radon xenon
        echo "ğŸ“Š Analyzing code complexity..."
        radon cc . --min B --show-complexity
        radon mi . --min B
        xenon . --max-absolute B --max-modules A --max-average A

    - name: ğŸ“ Generate PR Review Summary
      run: |
        echo "## ğŸ” Automated Code Review Summary" >> pr-review.md
        echo "" >> pr-review.md
        echo "### âœ… Quality Checks Passed" >> pr-review.md
        echo "- âœ… Code linting (Ruff)" >> pr-review.md
        echo "- âœ… Code formatting (Black)" >> pr-review.md
        echo "- âœ… Type checking (MyPy)" >> pr-review.md
        echo "- âœ… Security scan (Bandit)" >> pr-review.md
        echo "- âœ… Dependency security (Safety)" >> pr-review.md
        echo "- âœ… Code complexity analysis" >> pr-review.md

  # ==========================================
  # ğŸ§ª DIFFERENTIAL TESTING  
  # ==========================================
  diff-testing:
    name: ğŸ§ª Differential Testing
    runs-on: ubuntu-latest
    
    services:
      weaviate:
        image: semitechnologies/weaviate:1.22.4
        ports:
          - 8080:8080
        env:
          AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
    
    steps:
    - name: ğŸ“¥ Checkout PR Branch
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-html pytest-xdist

    - name: ğŸ§ª Run Full Test Suite
      env:
        SAPTIVA_API_KEY: ${{ secrets.SAPTIVA_API_KEY_TEST }}
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY_TEST }}
        WEAVIATE_HOST: http://localhost:8080
        ENVIRONMENT: test
      run: |
        echo "ğŸ§ª Running comprehensive test suite on PR changes..."
        python -m pytest \
          --cov=. \
          --cov-report=xml \
          --cov-report=term-missing \
          --html=pr-test-results.html \
          --tb=short \
          -v \
          -n auto

    - name: ğŸ“ˆ Coverage Comparison
      uses: orgoro/coverage@v3
      with:
        coverageFile: coverage.xml
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Upload PR Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: pr-test-results
        path: |
          pr-test-results.html
          coverage.xml

  # ==========================================
  # ğŸš¨ BREAKING CHANGES DETECTION
  # ==========================================
  breaking-changes:
    name: ğŸš¨ Breaking Changes Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Analyze API Changes
      run: |
        echo "ğŸ” Analyzing potential breaking changes..."
        
        # Check for API endpoint changes
        if git diff origin/main...HEAD --name-only | grep -q "apps/api/main.py"; then
          echo "âš ï¸ API endpoints may have changed"
          git diff origin/main...HEAD apps/api/main.py
        fi
        
        # Check for model changes
        if git diff origin/main...HEAD --name-only | grep -q "domain/models/"; then
          echo "âš ï¸ Domain models may have changed"
          git diff origin/main...HEAD domain/models/
        fi
        
        # Check for port interface changes
        if git diff origin/main...HEAD --name-only | grep -q "ports/"; then
          echo "âš ï¸ Port interfaces may have changed"
          git diff origin/main...HEAD ports/
        fi

    - name: ğŸ“ Breaking Changes Report
      run: |
        echo "## ğŸš¨ Breaking Changes Analysis" >> breaking-changes.md
        echo "" >> breaking-changes.md
        echo "This PR has been analyzed for potential breaking changes." >> breaking-changes.md
        echo "" >> breaking-changes.md
        echo "### Files that could introduce breaking changes:" >> breaking-changes.md
        git diff --name-only origin/main...HEAD | grep -E "(apps/api/|domain/models/|ports/)" || echo "- No critical files modified" >> breaking-changes.md

  # ==========================================
  # ğŸ’¬ PR FEEDBACK
  # ==========================================
  pr-feedback:
    name: ğŸ’¬ PR Feedback & Summary
    runs-on: ubuntu-latest
    needs: [code-review, diff-testing, breaking-changes]
    if: always()
    
    steps:
    - name: ğŸ“¥ Download Artifacts
      uses: actions/download-artifact@v3
      with:
        name: pr-test-results
        path: ./results

    - name: ğŸ’¬ Post PR Comment
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let comment = `## ğŸ¤– Automated PR Review Complete\n\n`;
          comment += `### ğŸ“Š Test Results\n`;
          comment += `- **Tests**: ${{ needs.diff-testing.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}\n`;
          comment += `- **Code Quality**: ${{ needs.code-review.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}\n`;
          comment += `- **Breaking Changes**: ${{ needs.breaking-changes.result == 'success' && 'âœ… None detected' || 'âš ï¸ Potential issues found' }}\n\n`;
          
          comment += `### ğŸ¯ Next Steps\n`;
          if ('${{ needs.diff-testing.result }}' !== 'success') {
            comment += `- âŒ Fix failing tests before merge\n`;
          }
          if ('${{ needs.code-review.result }}' !== 'success') {
            comment += `- âŒ Address code quality issues\n`;
          }
          if ('${{ needs.breaking-changes.result }}' !== 'success') {
            comment += `- âš ï¸ Review potential breaking changes\n`;
          }
          if ('${{ needs.diff-testing.result }}' === 'success' && '${{ needs.code-review.result }}' === 'success') {
            comment += `- âœ… Ready for human review and merge!\n`;
          }
          
          comment += `\n---\n*Generated by Aletheia CI/CD Pipeline*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });